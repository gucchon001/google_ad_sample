# Google Ads 広告分析レポート作成システム 仕様書

## 概要
このシステムは、Google Ads APIを使用して広告データを取得し、Google スプレッドシートに出力した後、そのデータを分析して広告パフォーマンスレポートを生成するものです。

## 目的
- Google Ads APIから広告キャンペーンのパフォーマンスデータを自動取得する
- 取得したデータをスプレッドシートに整形して出力する
- スプレッドシートのデータを分析し、意思決定に役立つレポートを生成する

## 機能要件
1. Google Ads APIからの認証とデータ取得
2. 取得データのスプレッドシート出力
3. スプレッドシートデータの統計分析
4. 分析結果のレポート生成

## 技術仕様
- 言語: Python 3.10+
- 主要ライブラリ:
  - google-ads: Google Ads APIクライアント
  - google-api-python-client: Google APIアクセス
  - pandas: データ処理・分析
  - matplotlib/seaborn: データ可視化
  - numpy: 数値計算

## データフロー
1. 環境変数から認証情報を取得
2. Google Ads APIに接続してデータを取得
3. 取得データをスプレッドシートに出力
4. スプレッドシートからデータを読み込んで分析
5. 分析結果をレポートとして出力

## 制約条件
- Google Ads APIの利用制限に準拠すること
- 認証情報は環境変数で安全に管理すること
- 分析処理は定期的に実行できること

## エラー処理
- API接続エラー: リトライ処理と適切なログ出力
- データ不整合エラー: 検証処理と警告通知

## 将来の拡張性
- 複数アカウントの一括処理
- 自動レポート配信機能
- インタラクティブなダッシュボード

## 変更履歴
| 日付 | バージョン | 変更内容 | 担当者 |
|------|------------|----------|--------|
| YYYY-MM-DD | 0.1 | 初版作成 | [名前] |

## 1. システム概要

本システムは、Google Ads APIを使用して広告データを取得し、スプレッドシートに出力した後、そのデータを分析して広告パフォーマンスの改善提案を行うシステムです。

### 1.1 主要機能

1. **Google Ads API連携**  
   Google Ads APIから広告データを取得します。
   - 認証情報の安全な管理
   - 必要なメトリクスの取得
   - データの前処理

2. **スプレッドシート出力**  
   取得したデータをGoogle スプレッドシートに整形して出力します。
   - シート自動作成
   - データ整形
   - 定期更新

3. **データ分析**  
   スプレッドシートのデータを分析し、インサイトを抽出します。
   - パフォーマンス指標の計算
   - トレンド分析
   - 異常値検出

4. **レポート生成**  
   分析結果をもとに、意思決定に役立つレポートを生成します。
   - グラフ作成
   - 改善提案
   - 定期レポート

5. **テストモード**  
   - `--test` オプション付与で実行すると、テスト用の動作を行います。

---

## 2. システム構成

### 2.1 ディレクトリ構造
```
project_root/
├── src/
│   ├── main.py                # メインスクリプト(エントリーポイント)
│   ├── modules/               # 機能モジュール
│   │   ├── google_ads.py      # Google Ads API連携
│   │   ├── spreadsheet.py     # スプレッドシート操作
│   │   └── analytics.py       # データ分析
│   └── utils/
│       ├── environment.py     # 環境設定（settings.ini 等）
│       ├── helpers.py         # ヘルパー関数
│       └── logging_config.py  # ログ設定
├── config/
│   ├── settings.ini           # システム設定
│   └── secrets.env            # API認証情報
├── logs/                      # ログファイル格納先
├── tests/                     # テストコード
│   ├── __init__.py
│   ├── test_google_ads.py
│   └── test_analytics.py
├── docs/                      # ドキュメント
│   ├── spec.md                # 仕様書 (本ファイル)
│   └── setup.md               # セットアップガイド
├── data/                      # データファイル
├── requirements.txt           # Python依存パッケージ
└── README.md                  # プロジェクト説明
```

### 2.2 外部連携
- Google Ads API: 広告データの取得
- Google Sheets API: スプレッドシートへのデータ出力
- Google Drive API: ファイル管理

### 2.3 設定ファイル (settings.ini)
```ini
[GOOGLE_ADS]
# 取得するメトリクス
metrics = impressions,clicks,cost_micros,conversions,ctr,average_cpc
# 取得期間（日数）
period_days = 30
# 取得するキャンペーンステータス
campaign_status = ENABLED
# 取得件数上限
limit = 100

[SPREADSHEET]
# 出力先スプレッドシートID
spreadsheet_id = your_spreadsheet_id
# シート名
sheet_name = GoogleAdsData
# 自動更新間隔（時間）
update_interval = 24

[ANALYTICS]
# 分析対象指標
target_metrics = ctr,conversions,cost_per_conversion
# 異常値検出しきい値
outlier_threshold = 2.0
# トレンド分析期間（日）
trend_period = 7
```

### 2.4 モジュール/ファイル詳細

| ファイル                | 概要                                                       |
| ----------------------- | ---------------------------------------------------------- |
| **main.py**             | エントリーポイント。処理フローを制御します。               |
| **google_ads.py**       | Google Ads APIとの連携、データ取得を行います。             |
| **spreadsheet.py**      | スプレッドシートへのデータ出力を行います。                 |
| **analytics.py**        | データ分析とレポート生成を行います。                       |
| **environment.py**      | 設定ファイルや環境変数からの値読込を行います。             |
| **helpers.py**          | 汎用的なヘルパー関数を提供します。                         |
| **logging_config.py**   | ログのレベル、フォーマット設定を行います。                 |

---

## 3. 機能仕様

### 3.1 基本フロー
1. 環境設定の読み込み
2. Google Ads API認証情報の取得
3. 広告データの取得
4. データの前処理
5. スプレッドシートへのデータ出力
6. スプレッドシートからのデータ読み込み
7. データ分析の実行
8. 分析結果のレポート生成

### 3.2 Google Ads API連携の詳細
- 認証情報は secrets.env から安全に取得
- YAML設定ファイルを動的に生成
- 指定されたメトリクスと期間でデータを取得
- エラーハンドリングとリトライ処理

### 3.3 スプレッドシート出力の詳細
- 指定されたスプレッドシートIDとシート名にデータを出力
- 既存データの更新または新規シートの作成
- データの整形（ヘッダー、フォーマット）
- タイムスタンプの付与

### 3.4 設定項目
| 項目 | 説明 | 形式 |
|------|------|------|
| GOOGLE_ADS_DEVELOPER_TOKEN | Google Ads API開発者トークン | 文字列 |
| GOOGLE_ADS_CLIENT_ID | OAuth 2.0クライアントID | 文字列 |
| GOOGLE_ADS_CLIENT_SECRET | OAuth 2.0クライアントシークレット | 文字列 |
| GOOGLE_ADS_REFRESH_TOKEN | OAuth 2.0リフレッシュトークン | 文字列 |
| GOOGLE_ADS_LOGIN_CUSTOMER_ID | Google Adsログイン顧客ID | 数値 |
| SPREADSHEET_ID | 出力先スプレッドシートID | 文字列 |

---

## 4. 技術仕様

### 4.1 使用技術
- Python 3.10+
- Google Ads API Python クライアント
- Google API Python クライアント
- pandas データ分析ライブラリ
- matplotlib/seaborn データ可視化ライブラリ
- numpy 数値計算ライブラリ

### 4.2 エラー処理
1. API接続エラー
   - 一時的なエラーの場合は最大3回リトライ
   - 認証エラーの場合は詳細なエラーメッセージを表示

2. データ不整合エラー
   - 必須フィールドの欠損チェック
   - 異常値の検出と警告

### 4.3 セキュリティ
- 認証情報は環境変数で管理
- APIキーやトークンはソースコードに直接記述しない
- YAMLファイルは一時的に生成し、処理後に削除

---

## 5. 処理フロー

1. **起動/初期化**  
   - 環境変数とコマンドライン引数の解析
   - ログ設定の初期化
   - 設定ファイルの読み込み

2. **Google Ads API認証**  
   - secrets.envから認証情報を取得
   - YAMLファイルの動的生成
   - Google Ads APIクライアントの初期化

3. **データ取得**  
   - 取得するメトリクスと期間の設定
   - クエリの構築と実行
   - レスポンスデータの解析

4. **データ前処理**  
   - 必要なフィールドの抽出
   - データ型の変換
   - 欠損値の処理

5. **スプレッドシート出力**  
   - スプレッドシートAPIの認証
   - シートの存在確認と作成
   - データの整形と書き込み

6. **データ分析**  
   - スプレッドシートからのデータ読み込み
   - 統計分析の実行
   - インサイトの抽出

7. **レポート生成**  
   - 分析結果の整形
   - グラフの生成
   - レポートの出力

---

## 6. Google Ads API連携の詳細

### 6.1 認証プロセス
1. secrets.envから認証情報を取得
2. google-ads.yamlファイルを動的に生成
3. GoogleAdsClientを初期化

### 6.2 データ取得
1. 取得するメトリクスを設定ファイルから読み込み
2. 取得期間を設定ファイルから読み込み
3. クエリを構築
4. APIリクエストを実行
5. レスポンスデータを解析

### 6.3 エラーハンドリング
1. 一時的なエラーの場合はリトライ
2. 認証エラーの場合は詳細なエラーメッセージを表示
3. クエリエラーの場合はクエリを修正して再実行

---

## 7. スプレッドシート出力の詳細

### 7.1 認証プロセス
1. サービスアカウントまたはOAuth2.0認証を使用
2. Google Sheets APIクライアントを初期化

### 7.2 データ出力
1. 出力先スプレッドシートとシートを特定
2. シートが存在しない場合は新規作成
3. データを整形（ヘッダー、フォーマット）
4. データを書き込み

### 7.3 更新処理
1. 既存データの確認
2. 差分の特定
3. 更新または追記

---

## 8. データ分析の詳細

### 8.1 基本統計量
1. 各メトリクスの平均、中央値、標準偏差
2. パフォーマンス指標の計算（CPA、ROAS等）

### 8.2 トレンド分析
1. 時系列データの分析
2. 曜日・時間帯別パフォーマンス
3. 成長率の計算

### 8.3 異常値検出
1. 統計的手法による異常値の検出
2. パフォーマンス急変の検出
3. 予算消化率の監視

---

## 9. レポート生成の詳細

### 9.1 レポート形式
1. CSVファイル
2. PDFレポート
3. ダッシュボード

### 9.2 レポート内容
1. パフォーマンスサマリー
2. 主要KPIの推移グラフ
3. 改善提案
4. アラート情報

---

## 10. 運用・保守

### 10.1 定期実行
1. 日次バッチ処理
2. スケジューラーの設定
3. 実行ログの管理

### 10.2 エラー監視
1. ログの定期確認
2. エラー通知の設定
3. 自動リカバリー処理

### 10.3 データバックアップ
1. スプレッドシートのバックアップ
2. 分析結果のアーカイブ
3. 設定ファイルの管理

---

## 11. セキュリティ

### 11.1 認証情報の管理
1. secrets.envでの管理
2. 環境変数の使用
3. トークンの定期更新

### 11.2 アクセス制御
1. 最小権限の原則
2. APIスコープの制限
3. ユーザー認証の実装

---

## 12. 開発・テスト

### 12.1 開発環境
1. Python 3.10+
2. 必要なライブラリ
3. テスト用アカウント

### 12.2 テスト方法
1. 単体テスト
2. 結合テスト
3. エンドツーエンドテスト

### 12.3 デプロイ手順
1. 環境構築
2. 設定ファイルの準備
3. 初期実行とテスト

---

**© 2023 [組織名]**  
本システム仕様書の内容は今後予告なく変更されることがあります。

## MetricsConfigUtils クラス仕様書

### 概要
`MetricsConfigUtils` クラスは、スプレッドシートからメトリクス設定を読み込み、Google Ads API クエリのためのパラメータを管理するユーティリティクラスです。

### 主な機能
- **メトリクス設定の取得**: スプレッドシートからメトリクス設定を読み込み、キャッシュします。
- **アクティブメトリクスの取得**: アクティブなメトリクス項目のリストを取得します。
- **クエリパラメータの取得**: Google Ads API クエリに必要なパラメータを取得します。
- **クエリの構築**: Google Ads API クエリを構築し、クエリ文字列とパラメータの辞書を返します。
- **計算フィールドの取得**: 計算フィールドの情報を取得します。

### メソッド詳細

#### `get_metrics_config()`
- **説明**: スプレッドシートからメトリクス設定を読み込み、DataFrame として返します。
- **戻り値**: `pd.DataFrame` - メトリクス設定の DataFrame
- **例外**: スプレッドシートの読み取りに失敗した場合に例外をスローします。

#### `get_active_metrics()`
- **説明**: アクティブなメトリクス項目のリストを取得します。
- **戻り値**: `List[str]` - アクティブなメトリクス項目のリスト

#### `get_query_parameters()`
- **説明**: クエリパラメータを取得します。
- **戻り値**: `Dict[str, Any]` - クエリパラメータの辞書

#### `build_query()`
- **説明**: Google Ads API クエリを構築します。
- **戻り値**: `Tuple[str, Dict[str, Any]]` - クエリ文字列とパラメータの辞書

#### `get_calculated_metrics()`
- **説明**: 計算フィールドの情報を取得します。
- **戻り値**: `Dict[str, Dict[str, Any]]` - 計算フィールドの情報

### 制限事項
- スプレッドシートの構造が変更された場合、メソッドの動作に影響を与える可能性があります。
- スプレッドシートの読み込みに失敗した場合、例外が発生します。

### 変更履歴
- **2023-10-XX**: 初版作成 